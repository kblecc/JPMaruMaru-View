<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bootstrap 5 example</title>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-dotimeout/1.0/jquery.ba-dotimeout.min.js"></script>
    <link rel="stylesheet" href="https://raw.githubusercontent.com/kblecc/JPMaruMaru-View/refs/heads/main/css/lyrics.css" />

    <link rel="stylesheet" href="https://raw.githubusercontent.com/kblecc/JPMaruMaru-View/refs/heads/main/css/style.css" />
    <script>
      var jsonData = {};

      $(document).ready(async function () {
        // Theme switch functionality
        document
          .getElementById("theme-switch")
          .addEventListener("click", toggleTheme);

        // Fetch song data and initialize YouTube player
        try {
          await fetchSongData();
          loadYouTubeAPI();
        } catch (error) {
          console.error("Error during initialization:", error);
          alert("Failed to load song data. Please try again later.");
        }
      });

      // Toggle theme function
      function toggleTheme() {
        const currentTheme =
          document.documentElement.getAttribute("data-bs-theme");
        document.documentElement.setAttribute(
          "data-bs-theme",
          currentTheme === "dark" ? "light" : "dark"
        );
      }

      // Function to get a specific query parameter by name
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      // Function to fetch song data based on the id from the URL
      async function fetchSongData() {
        const id = getQueryParam("id"); // Get the 'id' parameter from the URL
        if (!id) {
          throw new Error("No id parameter found in the URL.");
        }

        const jsonUrl = `https://raw.githubusercontent.com/kblecc/JPMaruMaru-Archive/refs/heads/main/${id}.json`; // Construct the URL for the JSON file
        console.log("Fetching JSON from:", jsonUrl); // Log the URL
        try {
          const response = await $.getJSON(jsonUrl);
          $("#LyricsList").html(response.lyrics); // Update the lyrics in the div
          jsonData = response; // Store the fetched data
          onYouTubeIframeAPIReady(jsonData.videoID); // Initialize YouTube player with videoID
        } catch (error) {
          console.error("Error fetching the JSON data:", error);
          alert("Failed to fetch song data: " + error.message); // Show the error message
          throw new Error("Failed to fetch song data.");
        }
      }

      // Load YouTube API
      function loadYouTubeAPI() {
        const tag = document.createElement("script");
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName("script")[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
      }

      // Instantiate the Player.
      function onYouTubeIframeAPIReady(videoID) {
        var player = new YT.Player("player", {
          videoId: videoID,
          width: "100%",
          events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
          },
        });
      }

      // Player ready event
      function onPlayerReady(e) {
        $("#mtime").text(formatSec(e.target.getDuration())); // Display total duration
      }

      // Player state change event
      function onPlayerStateChange(e) {
        if (e.data === YT.PlayerState.PLAYING) {
          $.doTimeout("showLyrics", 500, function () {
            updateLyrics(e.target);
          });
        } else {
          $.doTimeout("showLyrics"); // Clear doTimeout
        }
      }

      // Update lyrics based on current time
      function updateLyrics(player) {
        const mtime = Math.round(player.getCurrentTime());
        $("#mtime").text(formatSec(mtime)); // Update current time display

        const stList = $(".LyricsYomi").length;
        let r = -1;

        for (let i = 0; i < stList; i++) {
          const st1 = convertLST($(".LyricsYomi").eq(i).attr("st"));
          const st2 =
            i < stList - 1
              ? convertLST(
                  $(".LyricsYomi")
                    .eq(i + 1)
                    .attr("st")
                )
              : Infinity;

          if (mtime < st1) {
            break;
          } else if (mtime >= st1 && mtime < st2) {
            r = i;
            break;
          }
        }

        if (r > -1) {
          displayCurrentLyrics(r);
        }
      }

      // Display current lyrics
      function displayCurrentLyrics(index) {
        const sn1 = $(".LyricsYomi").eq(index).html();
        const sn2 = $(".Translate_zh").eq(index).html();
        const sn = `<li lang='ja' class='li3'>${sn1}</li><li class='li4'> ${sn2}</li>`;
        $("#ly").html(sn);
        $(".LyricsYomi").css("color", "var(--bs-primary-text-emphasis)");
        $(".Translate_zh").css("color", "gray");
        $(".LyricsYomi").eq(index).css("color", "red");
        $(".Translate_zh").eq(index).css("color", "red");

        const section = $(".LyricsYomi[sn=" + index + "]");
        $(".s_lyrics").scrollTo(section, 500);
      }

      // Convert time string to seconds
      function convertLST(a) {
        const b = convertTimeToSec(a);
        return (b - parseFloat(LST)).toFixed(3);
      }

      // Convert time format to seconds
      function convertTimeToSec(c) {
        const e =
          /^(([0-1][0-9])|([2][0-3])):(([0-5][0-9])):(([0-5][0-9])).(([0-9][0-9][0-9]))$/;
        if (!e.test(c)) return "";
        const [b, g, a, d] = [
          c.substr(0, 2),
          c.substr(3, 2),
          c.substr(6, 2),
          c.substr(9, 3),
        ];
        return b * 3600 + g * 60 + +a + d / 1000;
      }

      // Format seconds into hh:mm:ss
      function formatSec(seconds) {
        const daySec = 86400,
          hourSec = 3600,
          minuteSec = 60;
        const dd = Math.floor(seconds / daySec);
        const hh = Math.floor((seconds % daySec) / hourSec);
        const mm = Math.floor((seconds % hourSec) / minuteSec);
        const ss = seconds % minuteSec;

        return [dd, hh, mm, ss]
          .map((v) => (v < 10 ? "0" + v : v))
          .join(":")
          .replace(/^00:/, "");
      }
    </script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row 100-vh">
        <div class="col sticky-top" id="yt_info">
          <div id="player" class="yt_warpper"></div>
          <div class="container" id="control">
            <button
              type="button"
              class="btn btn-primary"
              id="setting_btn"
              data-bs-toggle="modal"
              data-bs-target="#setting_modal"
            >
              Primary
            </button>
            <button type="button" class="btn btn-primary" id="theme-switch">
              Primary
            </button>
            <span id="mtime">--.---</span>
          </div>

          <div class="table-tr">
            <div class="table-td showly">
              <span id="ly">
                <li class="li3" lang="ja">
                  <ruby>
                    <rb>雪</rb>
                    <rt>ゆき</rt> </ruby
                  >の<ruby>
                    <rb>華</rb>
                    <rt>はな</rt>
                  </ruby>
                  -
                  <ruby>
                    <rb>中島美嘉</rb>
                    <rt>なかしまみか</rt>
                  </ruby>
                </li>
                <li class="li4">雪花 - 中島美嘉</li>
              </span>
            </div>
          </div>
        </div>

        <div class="col s_lyrics">
          <div
            id="LyricsList"
            class="easyui-panel panel-body"
            title=""
            style="padding: 10px; width: 558.667px"
            data-options="collapsible:true,collapsed:false"
          ></div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div
      class="modal fade"
      id="setting_modal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">...</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
